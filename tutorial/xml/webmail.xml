<chapter id="webmail"><?dbhtml filename="webmail.html"?>
    <title>Web Mail</title>

    <section id="why_squirrelmail"><?dbhtml filename="why_squirrelmail.html"?>
        <title>Why SquirrelMail</title>
        <para></para>
    </section>


    <!-- SquirrelMail Core -->
    <section id="squirrelmail"><?dbhtml filename="squirrelmail.html"?>
        <title>SquirrelMail</title>

        <!-- SquirrelMail Installation -->
        <section id="squirrelmail_installation"><?dbhtml filename="squirrelmail_installation.html"?>
            <title>安装 SquirrelMail</title>
            <para>
                <orderedlist>
                    <listitem><para>从 <ulink url="http://www.squirrelmail.org/">SquerrilMail 官方网站</ulink> 的 <ulink url="http://www.squirrelmail.org/download.php">下载页面</ulink> 下载最新版本（本文档使用的是 1.4.13 版本）。</para></listitem>
                    <listitem><para>解压到服务器的 /var/www/htdocs/ 目录：

<programlisting>
# export VERSION='1.4.13'
# bzip2 -d squirrelmail-${VERSION}.tar.bz2     
# tar xf squirrelmail-${VERSION}.tar -C /var/www/
# cd /var/www/htdocs/
# ln -s ../squirrelmail-${VERSION} mail
</programlisting>
                    </para></listitem>

                    <listitem><para>设置权限：

<programlisting>
# chown -R www:www /var/www/squirrelmail-${VERSION}/
# chmod -R 755 /var/www/squirrelmail-${VERSION}/
</programlisting>
                    </para></listitem>

                    <listitem><para>创建目录，用于存放邮件附件等数据： 

<programlisting>
# cd /var/www/squirrelmail-${VERSION}/
# mkdir data attach
# chown www:www data attach
# chmod 730 attach
</programlisting>
                    </para></listitem>

                </orderedlist>
            </para>
        </section>
        <!-- End SquirrelMail Installation -->


        <!-- SquirrelMail Configuration -->
        <section id="squirrelmail_configuration"><?dbhtml filename="squirrelmail_configuration.html"?>
            <title>配置 SquirrelMail</title>

            <para>
                SquirrelMail 为管理员提供了方便的配置工具（一个 Perl 脚本），运行之后显示的是这样的菜单：
<programlisting><![CDATA[
# /var/www/htdocs/mail/config/conf.pl

SquirrelMail Configuration : Read: config.php (1.4.0)
---------------------------------------------------------
Main Menu --
1.  Organization Preferences
2.  Server Settings
3.  Folder Defaults
4.  General Options
5.  Themes
6.  Address Books
7.  Message of the Day (MOTD)
8.  Plugins
9.  Database
10. Languages

D.  Set pre-defined settings for specific IMAP servers

C   Turn color on
S   Save data
Q   Quit

Command >>]]>
</programlisting>

<para>输入菜单前的数字或字母即可进入对应的配置选项。</para>

这里有几个参数需要修改：

<itemizedlist>
    <listitem><para>Server Settings

    <itemizedlist>
        <listitem><para>Update IMAP Settings

            <itemizedlist>
                <listitem><para>IMAP Server（将 localhost 改成 '127.0.0.1'）</para></listitem>
            </itemizedlist>

        </para></listitem>

        <listitem><para>Update SMTP Settings
            <itemizedlist>
                <listitem><para>SMTP Server（将 localhost 改成 '127.0.0.1'）</para></listitem>
            </itemizedlist>
        </para></listitem>

    </itemizedlist>

    </para></listitem>

    <listitem><para>General Options
        <itemizedlist>
            <listitem><para>Data Directory （设置为：/squirrelmail-${VERSION}/data/。一定要记得将这里的 ${VERSION} 替换为实际的版本号。）</para></listitem>
            <listitem><para>Attachment Directory （设置为：/squirrelmail-${VERSION}/attach/。一定要记得将这里的 ${VERSION} 替换为实际的版本号。）</para></listitem>
        </itemizedlist>
    </para></listitem>

    <listitem><para>Languages
        <itemizedlist>
            <listitem><para>Default Language（设置为 zh_CN）</para></listitem>
            <listitem><para>Default Charset（改成 gb2312，否则会导致邮件乱码）</para></listitem>
        </itemizedlist>
    </para></listitem>

    <listitem><para>Set pre-defined settings for specific IMAP servers
        <itemizedlist>
            <listitem><para>courier</para></listitem>
        </itemizedlist>
    </para></listitem>
</itemizedlist>

<important><title>chrooted apache</title>
    <para>
        因为 Apache 默认是被 chroot 在 /var/www/ 目录下，所以这里的 "Data Directory" 和 "Attachment Directory" 目录必须这么写。
    </para>
</important>

<tip><title>检查配置</title>
    <para>配置完成之后，可以使用 configtest.php 页面帮助检查设置是否正确： http://your_server_ip/mail/src/configtest.php</para>
</tip>

OK，如果没有什么问题的话，现在就可以登录 WebMail 了： http://your_server_ip/mail/ 。看到的登录画面类似于：

    <figure id="squirrelmail_login_page"><title>SquirrelMail 登录界面</title>
        <graphic fileref="images/squirrelmail/login.png"/>
    </figure>

            </para>
        </section>
        <!-- End SquirrelMail Configuration -->

        <!-- SquirrelMail Translations -->
        <section id="squirrelmail_translations"><?dbhtml filename="squirrelmail_translations.html"?>
            <title>Translations</title>
            <para>刚才已经安装和配置好了 SquirrelMail，但是界面还只是英文的，需要安装 Translations 以支持其它语言的界面显示。</para>

            <para>从 <ulink url="http://squirrelmail.org/download.php">SquirrelMail 下载页面</ulink> 下载需要的 translation。这里使用 all_locales-1.4.13-20071220.tar.bz2，包含最多种语言的翻译，你也可以只下载单个语言的翻译包。</para>

            <para>下载后将它解压，然后将解压出来的目录和文件复制到对应的目录即可：
<programlisting>
# bzip2 -d all_locales-1.4.13-20071220.tar.bz2
# tar xf all_locales-1.4.13-20071220.tar
</programlisting>
解压后在当前目录有一个 'install' 脚本，它会复制所有需要的文件：
<programlisting>
# sh install
Please enter path to your squirrelmail installation:
</programlisting>

在提示符下输入 SquirrelMail 的安装地址：
<programlisting>
/var/www/htdocs/mail/
</programlisting>

到此，Translations 的安装就完成了。再通过 SquirrelMail 的配置工具 'conf.pl' 来设置默认语言和默认的字符集：
<programlisting>
# /var/www/htdocs/mail/config/conf.pl
</programlisting>

选择 'Languages' 一项，再设置以下两个参数：
<itemizedlist>
    <listitem><para>Default Language（简体中文使用 'zh_CN'，繁体中文用 'zh_TW'）</para></listitem>
    <listitem><para>Default Charset（简体中文用 'gb2312'，繁体中文用 'big5'）</para></listitem>
</itemizedlist>

<important><title>Default Charset</title>
    <para>SquirrelMail 里的 'zh_CN' 默认使用 'gb2312' 字符集，而 phpLDAPadmin 里所有属性的值都是用 'utf-8' 编码保存的，所以如果需要使用 LDAP 全局地址簿，则需要将 SquirrelMail 的 translation 文件的编码给转换成 'utf-8' 编码，否则看到的 LDAP 属性的值都将是乱码。</para>
    
    <para>这里以 'zh_CN' 为例，介绍如何使用 'iconv' 工具来转换字符集。</para>

    <para>
<programlisting>
# cd /var/www/htdocs/mail/locale/zh_CN/LC_MESSAGES/
# cp squirrelmail.po squirrelmail.po.bak
# iconv -f gb2312 -t utf-8 squirrelmail.po.bak >squirrelmail.po
</programlisting>

    再编辑 /var/www/htdocs/mail/locale/zh_CN/setup.php 文件，将文件里的 'gb2312' 改为 'utf-8'：
<programlisting>
$languages['zh_CN']['CHARSET'] = 'utf-8';
$languages['zh_CN']['LOCALE']  = array('zh_CN.UTF8','zh_CN');
</programlisting>

    再编辑 /var/www/htdocs/mail/functions/i18n.php 文件，将文件里的 'gb2312' 改为 'utf-8'：
<programlisting>
$languages['zh_CN']['CHARSET'] = 'utf-8';
</programlisting>

    这样就可以了。

    </para>
</important>

            </para>
        </section>
        <!-- End SquirrelMail Locales -->

    </section>
    <!-- End SquirrelMail Core -->




    <!-- SquirrelMail Plugins -->
    <section id="squirrelmail_plugins"><?dbhtml filename="squirrelmail_plugins.html"?>
        <title>SquirrelMail Plugins</title>

        <para>SquirrelMail 有丰富的 Plugins，可以在 <ulink url="http://www.squirrelmail.org/plugins_category.php?category_id=all">All Plugins</ulink> 页面找到所有的 Plugins。</para>

        <!-- Plugin: change_ldappass -->
        <section id="squirrelmail_plugin_change_ldappass"><?dbhtml filename="squirrelmail_plugin_change_ldappass.html"?>
            <title>change_ldappass</title>

            <para>change_ldappass 是提供给用户修改自己的邮箱密码的插件。</para>

            <para>
                <orderedlist>
                    <listitem><para>从 <ulink url="http://www.squirrelmail.org/plugin_view.php?id=26">change_ldappass 插件的主页</ulink> 下载最新版本。这里以 2.2-1.4.0 版本为例。</para></listitem>
                    <listitem><para>解压缩，并复制到正确的位置： 

<programlisting>
# tar zxf change_ldappass-2.2-1.4.0.tar.gz
# cp -rf change_ldappass /var/www/htdocs/mail/plugins/

# chown -R www:www /var/www/htdocs/mail/plugins/change_ldappass
# chmod -R 755 /var/www/htdocs/mail/plugins/change_ldappass
</programlisting>
                    </para></listitem>

                    <listitem><para>使用 SquirrelMail 的配置工具来启用插件： 
<programlisting>
# /var/www/htdocs/mail/config/conf.pl
</programlisting>

                    选择 "Plugins" 菜单项，它会列出所有当前可用的插件，选择 'change_ldappass' 这一项后保存退出即可。
                    </para></listitem>

                    <listitem><para>配置 change_ldappass：</para>

                        <para>
                            将配置文件模板复制一份：

<programlisting>
# cd /var/www/htdocs/mail/plugins/change_ldappass
# cp config_sample.php config.php
</programlisting>

在 config.php 文件中需要修改以下内容： 
<programlisting><![CDATA[
$ldap_server = '127.0.0.1';
$ldap_protocol_version = 3;
$ldap_password_field = 'userPassword';
$ldap_user_field = 'mail';
$ldap_base_dn = 'o=domains,dc=openbsdonly,dc=org';
$ldap_filter = '(&(objectClass=qmailUser)(accountStatus=active))';
$query_dn = 'cn=vmail,dc=openbsdonly,dc=org';
$query_pw = 'vmailpasswd';]]>
</programlisting>

修改完成之后，用户就可以登录到 SquirrelMail 里，通过菜单 'Options --> Change Password' 来修改自己的邮箱密码了。
                        </para>
                    </listitem>
                </orderedlist>

            </para>
        </section>
        <!-- End Plugin: change_ldappass -->



        <!-- Plugin: Compatibility -->
        <section id="squirrelmail_plugin_compatibility"><?dbhtml filename="squirrelmail_plugin_compatibility.html"?>
            <title>Compatibility</title>
            <para>这是一个用来保证其它一些插件可以 backward (and forward) compatible 的插件。<ulink url="http://www.squirrelmail.org/plugin_view.php?id=152">插件的主页</ulink> 介绍如下：
<blockquote>
This plugin allows any other plugin access to the functions and special variables needed to make it backward (and forward) compatible with most versions of SM in wide use. This eliminates the need for duplication of certain functions throughout many plugins. It also provides functionality that helps check that plugins have been installed and set up correctly. 
</blockquote>

            <para>由于以下几个插件需要 Compatibility 插件的支持，所以我们需要先安装 Compatibility 插件：
                <itemizedlist>
                    <listitem><para>Check Quota</para></listitem>
                </itemizedlist>
            </para>

            它的安装非常简单，只需要下载后解压到 SquirrelMail 的 'plugins/' 目录，再用 SquirrelMail 提供的 'conf.pl' 配置工具启用它即可。
<programlisting>
# tar zxf compatibility-2.0.9-1.0.tar.gz
# mv compatibility /var/www/htdocs/mail/plugins/

# chown -R www:www /var/www/htdocs/mail/plugins/compatibility/
# chmod -R 755 /var/www/htdocs/mail/plugins/compatibility/
</programlisting>

别忘了启用它：
<programlisting>
# /var/www/htdocs/mail/config/conf.pl
</programlisting>
            </para>
        </section>



        <!-- Plugin: Check Quota -->
        <section id="squirrelmail_plugin_check_quota"><?dbhtml filename="squirrelmail_plugin_check_quota.html"?>
            <title>Check Quota</title>
            <para>
                <ulink url="http://www.squirrelmail.org/plugin_view.php?id=237">Check Quota</ulink> 插件用于检查和显示用户的邮箱容量使用量。支持的 Quota 类型有：
                <itemizedlist>
                    <listitem><para>UNIX (filesystem)</para></listitem>
                    <listitem><para>IMAP-based</para></listitem>
                    <listitem><para>cPanel quotas</para></listitem>
                </itemizedlist>

                在这里我们使用的是 IMAP-based，配置非常的简单。
            </para>

            <para>
                从 <ulink url="http://www.squirrelmail.org/plugin_view.php?id=237">插件主页</ulink> 下载最新版本的源码，然后解压并配置。这里以 2.2-1.4.0 版本为例。
<programlisting>
# tar zxf check_quota-2.2-1.4.0.tar.gz
# mv check_quota /var/www/htdocs/mail/plugins/

# chown -R www:www /var/www/htdocs/mail/plugins/check_quota/
# chmod -R 755 /var/www/htdocs/mail/plugins/check_quota/

# cd /var/www/htdocs/mail/plugins/check_quota/
# cp config.sample.php config.php
</programlisting>

编辑配置文件 /var/www/htdocs/mail/plugins/check_quota/config.php，在第 28 行，将 quota_type 的值改为 '1' 即可。
<programlisting>
$settings['quota_type'] = 1;
</programlisting>

现在重新登录 SquirrelMail，即可在左上角看到 "Quota Usage" 的信息。

<note><title>Quota Usage</title>
    <para>如果用户邮箱为空，默认是不显示 "Quota Usage" 的。</para>
</note>

            </para>

            <figure id="quota_usage"><title>Check Quota：显示当前邮箱使用量</title>
                <graphic fileref="images/features/squirrelmail/quota_usage.png"/>
            </figure>

        </section>
        <!-- End Plugin: Check Quota -->


        <section id="squirrelmail_plugin_select_language"><?dbhtml filename="squirrelmail_plugin_select_language.html"?>
            <title>Select Language</title>
            <para><ulink url="http://www.squirrelmail.org/plugin_view.php?id=253">select_language</ulink> 在用户的登录的时候提供一个下拉菜单，用户可以选择登录 SquirrelMail 后界面语言。</para>

            <para>select_language 的安装非常简单，只需要解压后复制到正确的目录，再启用它即可。这里以 1.1-1.4.0 版本为例。
<programlisting>
# tar zxf select_language-1.1-1.4.0.tar.gz
# mv select_language /var/www/htdocs/mail/plugins/

# chown -R www:www /var/www/htdocs/mail/plugins/select_language/
# chmod -R 755 /var/www/htdocs/mail/plugins/select_language/
</programlisting>

使用 SquirrelMail 的配置工具启用它：
<programlisting>
# /var/www/htdocs/mail/config/conf.pl
</programlisting>

选择 'Languages' 菜单项，再选择 'select_language' 就可以了。
            </para>

            <para>这是启用插件后的截图：
                <figure id="select_language"><title>Select Languages</title>
                    <graphic fileref="images/features/squirrelmail/select_language.png"/>
                </figure>
            </para>
        </section>

    </section>
    <!-- End SquirrelMail Plugins -->

</chapter>
