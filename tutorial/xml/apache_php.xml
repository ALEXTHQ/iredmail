<chapter id="apache_php"><?dbhtml filename="apache_php.html"?>
    <title>Apache, PHP</title>

    <!-- Summary -->
    <section id="summary_apache_php"><?dbhtml filename="summary_apache_php.html"?>
        <title>Summary</title>
        <para>
            我们将使用 Apache+PHP 来支持以下几个程序的正常工作：
            <itemizedlist>
                <listitem><para>SquirrelMail：WebMail 程序。</para></listitem>
                <listitem><para>phpLDAPadmin：用于管理 OpenLDAP。</para></listitem>
            </itemizedlist>
        </para>
    </section>
    <!-- End Summary -->

    <!-- Apache -->
    <section id="apache"><?dbhtml filename="apache.html"?>
        <title>Apache</title>

        <section id="enable_apache"><?dbhtml filename="enable_apache.html"?>
            <title>启用 Apache</title>
            <para>OpenBSD 的基本系统中已经带了 Apache-1.3.x（在 4.2 -release 中是 1.3.29），所以只需要将它启用即可。</para>

            <para>
                编辑 /etc/rc.conf.local 文件，加入以下内容： 

<programlisting>
httpd_flags=""
</programlisting>

                <tip><title>RC 脚本</title>
                    <para>
                        建议不要直接修改 /etc/rc.conf(8) 文件。以下是 rc.conf(8) DESCRIPTION 的第二段内容，供大家参考：
<programlisting>
It is advisable to leave the /etc/rc.conf file untouched, and instead
create and edit a new /etc/rc.conf.local file.  Variables set in this
file will override variables previously set in /etc/rc.conf.
</programlisting>
                    </para>
                </tip>

                <note><title>Apache 目录结构</title>
                    <para>
                    Apahce 的所有文件都放在 /var/www/ 目录下，以下是几个主要的目录及其用途：
<programlisting><![CDATA[
/var/www/
      |- cgi-bin/   # <-- 存放 CGI 程序的主要目录
      |- conf/      # <-- 存放配置文件的目录
      |- htdocs/    # <-- 存放 Web 文件的目录
      |- logs/      # <-- 存放 apache 服务器的日志文件
      |- users/     # <-- 用于提供给系统用户作个人主页的目录]]>
</programlisting>
                    </para>
                </note>

        </para>
    </section>

    <section id="apache_control"><?dbhtml filename="apache_control.html"?>
        <title>启动、停止 Apache</title>
        <para>
            Apache 使用 apachectl 程序来启动和停止：
            <programlisting>
# apachectl start
# apachectl stop
</programlisting>
        </para>
    </section>
</section>
<!-- End Apache -->


<!-- PHP -->
<section id="php"><?dbhtml filename="php.html"?>
    <title>PHP</title>

    <!-- PHP Core -->
    <section id="php_core"><?dbhtml filename="php_core.html"?>
        <title>安装 PHP 核心程序（php5-core）</title>
        <para>
        安装 PHP：
        <programlisting>
# pkg_add php5-core

--- php5-core-5.2.3 -------------------
To finish the install, enable the php5 module with:
    /usr/local/sbin/phpxs -s

To enable parsing of PHP scripts, add the following to
/var/www/conf/httpd.conf:
    
    AddType application/x-httpd-php .php

Copy the config file below into /var/www/conf/php.ini
/usr/local/share/examples/php5/php.ini-recommended

Don't forget that the default OpenBSD httpd is chrooted
into /var/www by default, so you may need to create support
directories such as /var/www/tmp for PHP to work correctly.
</programlisting>

根据提示，执行以下命令：
<programlisting>
# /usr/local/sbin/phpxs -s

[activating module `php5' in /var/www/conf/httpd.conf]
cp /usr/local/lib/php/libphp5.so /usr/lib/apache/modules/libphp5.so
chmod 755 /usr/lib/apache/modules/libphp5.so
cp /var/www/conf/httpd.conf /var/www/conf/httpd.conf.bak
cp /var/www/conf/httpd.conf.new /var/www/conf/httpd.conf
rm /var/www/conf/httpd.conf.new

You should copy the sample configuration files from
/usr/local/share/examples/php5 to /var/www/conf/php.ini
</programlisting>

根据提示，复制 PHP 的配置文件 php.ini：
<programlisting>
# cp /usr/local/share/examples/php5/php.ini-recommended /var/www/conf/php.ini
</programlisting>

编辑 Apache 的配置文件（/var/www/conf/httpd.conf），让它能够识别和解析 PHP 文件：
<programlisting>
#
# 在 DirectoryIndex 参数中加上 PHP 的索引文件：index.php。
# index.php 和 index.html 的先后顺序决定了 apache 在进入一个目录的时候先读取哪个文件。

DirectoryIndex index.php index.html

#
# 将以下一行内容的注释符号给去掉：

AddType application/x-httpd-php .php
</programlisting>

重启 apache 之后，Apache 就能够识别和解析 PHP 文件了：
<programlisting>
# apachectl stop
# apachectl start
</programlisting>

现在可以创建一个 PHP 文件 /var/www/htdocs/index.php，用来测试 PHP 是否已经可以正确识别：
<programlisting><![CDATA[
<?php
    phpinfo();
?>]]>
</programlisting>

使用 Web 浏览器访问你的服务器首页的 index.php 文件，如果能够看到和以下截图类似的 PHP 信息，则表示 apache 已经可以正确识别和解析 PHP 文件。 

<figure id="php_info"><title>安装并配置好 PHP 后的 phpinfo() 页面信息</title>
    <graphic fileref="images/phpinfo.png"/>
</figure>

</para>
</section>
<!-- End PHP Core -->

    <!-- PHP Extensions -->
    <section id="php_extensions"><?dbhtml filename="php_extensions.html"?>
        <title>安装 PHP 扩展（Extensions）</title>

        <para>
            为了支持邮件服务器某些程序的运行，我们还需要安装以下 PHP 扩展：
            <itemizedlist>
                <listitem><para>php5-ldap：用于 phpLDAPadmin。</para></listitem>
                <listitem><para>php5-imap：用于 SquirrelMail WebMail。</para></listitem>
                <listitem><para>php5-mhash：为 phpLDAPadmin 提供加密算法支持。</para></listitem>
            </itemizedlist>

            安装并启用这些 Extensions：
<programlisting>
# pkg_add php5-ldap php5-imap php5-mhash
</programlisting>

<programlisting>
# /usr/local/sbin/phpxs -a ldap
# /usr/local/sbin/phpxs -a imap
# /usr/local/sbin/phpxs -a mhash
</programlisting>

重启 Apache 以使这些 Extensions 生效：
<programlisting>
# apache stop
# apache start
</programlisting>

之后在 phpinfo() 页面可以看到类似这样的信息：
<figure id="php_extensions"><title>PHP Extensions</title>
    <graphic fileref="images/php_extensions.png"/>
</figure>

            <important><title>Cyrus-SASL</title>
                <para>
                    注意：这里将 cyrus-sasl 作为依赖包给装上了，但是因为它不支持 LDAP，所以我们在后面需要将它替换掉。
                </para>
            </important>

            <tip><title>其它几个常用的 Extensions</title>
                <para>
                    以上几个 Extensions 是必须安装的，这里还有几个常用的 Extensions 大家也可以根据自己的需要安装：
                    <itemizedlist>
                        <listitem><para>php5-bz2</para></listitem>
                        <listitem><para>php5-gd</para></listitem>
                        <listitem><para>php5-mbstring</para></listitem>
                        <listitem><para>php5-mcrypt</para></listitem>
                        <listitem><para>php5-mysql</para></listitem>
                        <listitem><para>php5-sqlite</para></listitem>
                    </itemizedlist>
                </para>
            </tip>

        </para>

    </section>
    <!-- End PHP Extensions -->

</section>
<!-- End PHP -->


</chapter>
